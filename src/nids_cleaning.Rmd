---
title: "nids_cleaning"
author: "Megan"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
packages <- c("haven",
              "naniar",
              "tidyverse"
              )
invisible(lapply(packages, library, character.only = TRUE))
rm(packages)
```

```{r raw_data_files, echo=FALSE}

wave_1_adult <- read_dta("/Users/meganwhittaker/Thesis/mwhittaker-nids-cleaning/data/raw/wave_1/Adult_W1_Anon_V7.0.0.dta") %>% 
  zap_labels()

```


```{r age_firstbirth, echo=FALSE}

# AGE AT FIRST BIRTH
w1_birthyears <- wave_1_adult %>%
  select(pid, w1_a_dob_m, w1_a_dob_y, w1_a_bhdob_m1, w1_a_bhdob_y1) %>%
  rename(mother_birth_year = w1_a_dob_y,
         mother_birth_month = w1_a_dob_m,
         child_1_birth_year = w1_a_bhdob_y1,
         child_1_birth_month = w1_a_bhdob_m1)

# Non-response codes for year and month (NIDS Panel User Manual; 2018, p.27):
# month: 99, 88, 33
# year: 9999, 8888, 3333
# Change non-response codes to NA
w1_birthyears <-  w1_birthyears %>%
  mutate(across(ends_with("birth_month")), na_if(., 99)) %>%
  mutate(across(ends_with("birth_month")), na_if(., 88)) %>%
  mutate(across(ends_with("birth_month")), na_if(., 33)) 

w1_birthyears <-  w1_birthyears %>%
  mutate(across(ends_with("birth_year")), na_if(., 9999)) %>%
  mutate(across(ends_with("birth_year")), na_if(., 8888)) %>%
  mutate(across(ends_with("birth_year")), na_if(., 3333))  
  
# Age at first birth
w1_birthyears <-  w1_birthyears %>%
  filter(child_1_birth_year > mother_birth_year &
           child_1_birth_year - mother_birth_year >= 14 &
           child_1_birth_year - mother_birth_year <= 64) %>%
  mutate(age_firstbirth = ifelse(child_1_birth_month - mother_birth_month >= -11 & 
                                   child_1_birth_month - mother_birth_month <= 11 &
                                   !is.na(child_1_birth_month - mother_birth_month),
                                 floor((12*(child_1_birth_year - mother_birth_year) + child_1_birth_month - mother_birth_month)/12),
                                 (child_1_birth_year - mother_birth_year)))


Histogram(age_firstbirth, w1_birthyears, xlab = "Age at first birth", ylab = "Frequency", fill = "reds", color = "transparent")

```




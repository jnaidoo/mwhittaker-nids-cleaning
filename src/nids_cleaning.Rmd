---
title: "nids_cleaning"
author: "Megan"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
packages <- c("haven",
              "tidyverse"
              )
invisible(lapply(packages, library, character.only = TRUE))
rm(packages)
```

```{r raw_data_files, echo=FALSE}
wave_1_adult <- read_dta("../data/raw/wave_1/Adult_W1_Anon_V7.0.0.dta") %>% 
  zap_labels()
```

```{r , echo=FALSE}
# select and rename variables
w1_birthyears <-  wave_1_adult %>%
  select(pid, w1_a_dob_m, w1_a_dob_y, w1_a_bhdob_m1, w1_a_bhdob_y1) %>%
  rename(mother_birth_year = w1_a_dob_y,
         mother_birth_month = w1_a_dob_m,
         child_1_birth_year = w1_a_bhdob_y1,
         child_1_birth_month = w1_a_bhdob_m1)

# Non-response codes for year and month (NIDS Panel User Manual; 2018, p.27):
# month: 99, 88, 33
# year: 9999, 8888, 3333
# Change non-response codes to NA
w1_birthyears <-  w1_birthyears %>%
  mutate(across(ends_with("birth_month")), na_if(., 99)) %>%
  mutate(across(ends_with("birth_month")), na_if(., 88)) %>%
  mutate(across(ends_with("birth_month")), na_if(., 33)) 
w1_birthyears <-  w1_birthyears %>%
  mutate(across(ends_with("birth_year")), na_if(., 9999)) %>%
  mutate(across(ends_with("birth_year")), na_if(., 8888)) %>%
  mutate(across(ends_with("birth_year")), na_if(., 3333))  
  
# Age at first birth
w1_birthyears <-  w1_birthyears %>%
  filter(child_1_birth_year > mother_birth_year &
           child_1_birth_year - mother_birth_year >= 14 &
           child_1_birth_year - mother_birth_year <= 64) %>%
  mutate(age_firstbirth = ifelse(child_1_birth_month - mother_birth_month >= -11 & 
                                   child_1_birth_month - mother_birth_month <= 11 &
                                   !is.na(child_1_birth_month - mother_birth_month),
                                 floor((12*(child_1_birth_year - mother_birth_year) + child_1_birth_month - mother_birth_month)/12),
                                 (child_1_birth_year - mother_birth_year)))
```


```{r}
# generate histogram
hist(w1_birthyears$age_firstbirth, main = "Age at first birth - wave 1", xlab = "Age", ylab = "Frequency", col = "transparent")
```


```{r , echo=FALSE}
# an alternative plot (smoothed density)

w1_birthyears %>% ggplot(aes(x = age_firstbirth)) +
  geom_density() +
  labs(title = "Age at first birth",
       caption = "Source: NIDS Wave 1",
       x = "Age (years)",
       y = "") +
  theme_light()
```


```{r , echo=FALSE}

# select and rename variables
w1_bh <-  wave_1_adult %>%
  filter(w1_a_gen == 2) %>%
  select(pid, w1_a_bhlive_n, w1_a_bhali_n, w1_a_bhdth_n, contains("bhdob_y")) %>%
 rename(child_coresident_num = w1_a_bhlive_n,
         child_nonresident_alive_num = w1_a_bhali_n,
         child_nonresident_dead_num = w1_a_bhdth_n,
         child_1_birth_year = w1_a_bhdob_y1,
         child_2_birth_year = w1_a_bhdob_y2,
         child_3_birth_year = w1_a_bhdob_y3,
         child_4_birth_year = w1_a_bhdob_y4,
         child_5_birth_year = w1_a_bhdob_y5,
         child_6_birth_year = w1_a_bhdob_y6,
         child_7_birth_year = w1_a_bhdob_y7,
         child_8_birth_year = w1_a_bhdob_y8,
         child_9_birth_year = w1_a_bhdob_y9,
         child_10_birth_year = w1_a_bhdob_y10,
         child_11_birth_year = w1_a_bhdob_y11,
         child_12_birth_year = w1_a_bhdob_y12,
         child_13_birth_year = w1_a_bhdob_y13,
         child_14_birth_year = w1_a_bhdob_y14,
         child_15_birth_year = w1_a_bhdob_y15,
         child_16_birth_year = w1_a_bhdob_y16,
         child_17_birth_year = w1_a_bhdob_y17) 

# Non-response codes for year and month (NIDS Panel User Manual; 2018, p.27):
# month: 99, 88, 33
# year: 9999, 8888, 3333
# Change non-response codes to NA
w1_bh <-  w1_bh %>%
  mutate(across(ends_with("birth_year")), na_if(., 9999)) %>%
  mutate(across(ends_with("birth_year")), na_if(., 8888)) %>%
  mutate(across(ends_with("birth_year")), na_if(., 3333))

# Sum of children living with mother, children alive but not living with mother and children who have passed to get number of births
w1_bh <-  w1_bh %>%
  mutate(recorded_parity = child_coresident_num + child_nonresident_alive_num + child_nonresident_dead_num)

# Number of births for which birth timing data is available
w1_bh <-  w1_bh %>%
  sjmisc::row_count(count = NA, ends_with("birth_year"), var = "num_births_missing_yr", append = TRUE)

w1_bh <-  w1_bh %>%
mutate(implied_parity = 17 - num_births_missing_yr)

# Observations for which number of births don't equal birth data
w1_bh_neq <-  w1_bh %>% 
  filter(num_births != num_bhdata)

```

